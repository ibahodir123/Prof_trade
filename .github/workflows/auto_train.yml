name: ğŸ¤– Auto Train ML Model

on:
  schedule:
    # ĞšĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ Ğ² 2:00 UTC (Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ)
    - cron: '0 2 * * 0'
  
  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
  workflow_dispatch:
    inputs:
      model_type:
        description: 'Ğ¢Ğ¸Ğ¿ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ´Ğ»Ñ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ'
        required: true
        default: 'simple'
        type: choice
        options:
          - simple
          - full
      
      force_retrain:
        description: 'ĞŸÑ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¿ĞµÑ€ĞµĞ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ'
        required: false
        default: false
        type: boolean

jobs:
  train-model:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ§  Train simple model
      if: github.event.inputs.model_type == 'simple' || github.event_name == 'schedule'
      run: |
        echo "ğŸš€ ĞĞ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸..."
        python simple_train.py
        
    - name: ğŸ§  Train full model
      if: github.event.inputs.model_type == 'full'
      run: |
        echo "ğŸš€ ĞĞ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸..."
        python train_shooting_star_model.py --quick
        
    - name: ğŸ“Š Test model
      run: |
        echo "ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸..."
        python simple_demo.py
        
    - name: ğŸ“ Commit model files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
        git add simple_shooting_star_model.h5
        git add simple_shooting_star_scaler.pkl
        git add simple_shooting_star_metadata.json
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
        if git diff --staged --quiet; then
          echo "â„¹ï¸ ĞĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ² Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸"
        else
          git commit -m "ğŸ¤– Auto-update ML model [skip ci]"
          git push
          echo "âœ… ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ° Ğ² Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹"
        fi
        
    - name: ğŸ“ˆ Generate training report
      run: |
        echo "ğŸ“Š ĞÑ‚Ñ‡ĞµÑ‚ Ğ¾Ğ± Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸:" > training_report.md
        echo "=========================" >> training_report.md
        echo "" >> training_report.md
        echo "**Ğ”Ğ°Ñ‚Ğ° Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ:** $(date)" >> training_report.md
        echo "**Ğ¢Ğ¸Ğ¿ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸:** ${{ github.event.inputs.model_type || 'simple' }}" >> training_report.md
        echo "**Ğ—Ğ°Ğ¿ÑƒÑĞº:** ${{ github.event_name }}" >> training_report.md
        echo "" >> training_report.md
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
        if [ -f "simple_shooting_star_model.h5" ]; then
          echo "**Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸:** $(ls -lh simple_shooting_star_model.h5 | awk '{print $5}')" >> training_report.md
        fi
        
        if [ -f "simple_shooting_star_metadata.json" ]; then
          echo "**ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸:**" >> training_report.md
          cat simple_shooting_star_metadata.json >> training_report.md
        fi
        
        echo "" >> training_report.md
        echo "---" >> training_report.md
        echo "ğŸ¤– ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ GitHub Actions" >> training_report.md
        
    - name: ğŸ’¾ Upload training report
      uses: actions/upload-artifact@v3
      with:
        name: training-report
        path: training_report.md
        
    - name: ğŸ‰ Training completed
      run: |
        echo "ğŸ‰ ĞĞ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!"
        echo "ğŸ“Š ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"
