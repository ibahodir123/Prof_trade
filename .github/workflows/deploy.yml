name: üöÄ Deploy Trading Bot to Vultr

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üîÑ Checkout code
      uses: actions/checkout@v4

    - name: üîë Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

    - name: üì§ Deploy to server
      run: |
        echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä ${{ secrets.SERVER_IP }}..."

        # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
        ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} "mkdir -p /root/trading-bot"

        # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (–∏—Å–∫–ª—é—á–∞—è –Ω–µ–Ω—É–∂–Ω—ã–µ)
        rsync -avz --exclude='.git' --exclude='__pycache__' --exclude='*.pyc' \
              --exclude='*.log' --exclude='data_batch_*.json' \
              --exclude='movements_database.json' --exclude='patterns_database.json' \
              ./ root@${{ secrets.SERVER_IP }}:/root/trading-bot/

        echo "‚úÖ –§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã"

    - name: üõ†Ô∏è Setup server environment
      run: |
        ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} << 'EOF'
          cd /root/trading-bot

          # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
          apt update && apt upgrade -y

          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          apt install -y python3 python3-pip python3-venv curl wget git ufw

          # –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
          python3 -m venv trading_env
          source trading_env/bin/activate

          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements_web.txt

          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall
          ufw allow 5000
          ufw allow ssh
          ufw --force enable

          # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω
          systemctl stop trading-bot 2>/dev/null || true

          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞
          cp trading-bot.service /etc/systemd/system/
          systemctl daemon-reload

          # –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
          systemctl enable trading-bot

          echo "‚úÖ –°–µ—Ä–≤–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
        EOF

    - name: üöÄ Start application
      run: |
        ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} << 'EOF'
          cd /root/trading-bot

          # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
          systemctl start trading-bot

          # –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
          sleep 10

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
          systemctl status trading-bot --no-pager

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
          curl -f http://localhost:5000 || echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

          echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
          echo "üåê –î–æ—Å—Ç—É–ø–Ω–æ –Ω–∞: http://${{ secrets.SERVER_IP }}:5000"
        EOF

    - name: üìä Check deployment status
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è..."
        ssh -i ~/.ssh/id_rsa root@${{ secrets.SERVER_IP }} "systemctl status trading-bot --no-pager"
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

    - name: üîî Notify deployment success
      if: success()
      run: |
        echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
        echo "üåê –í–∞—à —Ç–æ—Ä–≥–æ–≤—ã–π –±–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞: http://${{ secrets.SERVER_IP }}:5000"
