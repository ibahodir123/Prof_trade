#!/bin/bash

# üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ Vultr –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ Vultr

echo "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è..."

# 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
apt update && apt upgrade -y

# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."
apt install -y python3 python3-pip python3-venv curl wget git ufw rsync

# 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall
echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall..."
ufw allow 5000
ufw allow ssh
ufw --force enable

# 4. –°–æ–∑–¥–∞–Ω–∏–µ SSH –∫–ª—é—á–∞ –¥–ª—è GitHub
echo "üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SSH –∫–ª—é—á–∞..."
ssh-keygen -t rsa -b 4096 -C "trading-bot-deploy" -f ~/.ssh/id_rsa -N ""

echo "üìã –í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π SSH –∫–ª—é—á (–¥–æ–±–∞–≤—å—Ç–µ –≤ GitHub):"
echo "================================================================="
cat ~/.ssh/id_rsa.pub
echo "================================================================="

# 5. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞..."
mkdir -p /root/trading-bot
cd /root/trading-bot

# 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git..."
git config --global user.name "GitHub Actions"
git config --global user.email "action@github.com"

# 7. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à)
echo "üîó –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
git clone https://github.com/–í–ê–®_USERNAME/–í–ê–®_REPO.git .
# –ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é: scp -r /–ø—É—Ç—å/–∫/—Ñ–∞–π–ª–∞–º root@–í–ê–®_IP:/root/trading-bot/

# 8. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üåê –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
python3 -m venv trading_env

# 9. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
source trading_env/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
pip install -r requirements_web.txt

# 10. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞
echo "‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞..."
cp trading-bot.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable trading-bot

echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üåê –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –î–æ–±–∞–≤—å—Ç–µ SSH –∫–ª—é—á –≤—ã—à–µ –≤ GitHub (Settings > SSH Keys)"
echo "2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ secrets –≤ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:"
echo "   - SERVER_IP: –í–ê–®_IP_–°–ï–†–í–ï–†–ê"
echo "   - SERVER_SSH_KEY: —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ ~/.ssh/id_rsa"
echo "3. –°–¥–µ–ª–∞–π—Ç–µ push –≤ main –≤–µ—Ç–∫—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞: ssh root@–í–ê–®_IP_–°–ï–†–í–ï–†–ê"
