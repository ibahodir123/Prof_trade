<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimized ML Bot Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js" defer></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" defer></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" defer></script>
</head>
<body class="bg-light">
<div class="container py-4">
    <h1 class="mb-4">Optimized ML Bot Dashboard</h1>

    <div class="mb-3">
        <button id="startBot" class="btn btn-success me-2">Start Bot</button>
        <button id="stopBot" class="btn btn-danger">Stop Bot</button>
        <span id="botStatus" class="ms-3 fw-bold">Status: unknown</span>
    </div>

    <div class="row" id="statisticsContent"></div>

    <div class="mt-4">
        <h3>Signals</h3>
        <div id="signalsList"></div>
    </div>

    <div class="mt-4">
        <h3>Price Chart</h3>
        <div id="priceChart"></div>
    </div>

    <div class="mt-5">
        <h3>Run Backtest</h3>
        <form id="backtestForm" class="row gy-2 gx-3 align-items-end">
            <div class="col-sm-4 col-md-3">
                <label for="backtestSymbol" class="form-label">Symbol</label>
                <select id="backtestSymbol" class="form-select"></select>
            </div>
            <div class="col-sm-4 col-md-3">
                <label for="backtestStart" class="form-label">Start date</label>
                <input type="date" id="backtestStart" class="form-control" required>
            </div>
            <div class="col-sm-4 col-md-3">
                <label for="backtestEnd" class="form-label">End date</label>
                <input type="date" id="backtestEnd" class="form-control" required>
            </div>
            <div class="col-sm-4 col-md-2">
                <label for="backtestTimeframe" class="form-label">Timeframe</label>
                <select id="backtestTimeframe" class="form-select">
                    <option value="1h">1h</option>
                    <option value="4h">4h</option>
                    <option value="1d">1d</option>
                </select>
            </div>
            <div class="col-sm-4 col-md-2">
                <label for="entryThreshold" class="form-label">Entry >=</label>
                <input type="number" min="0" max="1" step="0.05" value="0.6" id="entryThreshold" class="form-control">
            </div>
            <div class="col-sm-4 col-md-2">
                <label for="exitThreshold" class="form-label">Exit >=</label>
                <input type="number" min="0" max="1" step="0.05" value="0.6" id="exitThreshold" class="form-control">
            </div>
            <div class="col-sm-4 col-md-2">
                <button type="submit" class="btn btn-primary w-100 mt-2">Run</button>
            </div>
        </form>
        <div id="backtestResult" class="mt-3"></div>
        <div id="equityChart" class="mt-3"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const SYMBOLS = ["BTC/USDT", "ETH/USDT", "ADA/USDT", "XRP/USDT", "SOL/USDT", "BNB/USDT"];
    const socket = io();

    const symbolSelect = document.getElementById('backtestSymbol');
    symbolSelect.innerHTML = SYMBOLS.map(symbol => `<option value="${symbol}">${symbol}</option>`).join('');

    socket.on('dashboard_update', function (payload) {
        const statusText = payload.running ? 'running' : 'stopped';
        document.getElementById('botStatus').textContent = `Status: ${statusText}`;
    });

    document.getElementById('startBot').addEventListener('click', function () {
        fetch('/api/bot/start', { method: 'POST' });
    });

    document.getElementById('stopBot').addEventListener('click', function () {
        fetch('/api/bot/stop', { method: 'POST' });
    });

    document.getElementById('backtestForm').addEventListener('submit', function (event) {
        event.preventDefault();
        runBacktest();
    });

    function runBacktest() {
        const payload = {
            symbol: document.getElementById('backtestSymbol').value,
            start_date: document.getElementById('backtestStart').value,
            end_date: document.getElementById('backtestEnd').value,
            timeframe: document.getElementById('backtestTimeframe').value,
            entry_threshold: parseFloat(document.getElementById('entryThreshold').value),
            exit_threshold: parseFloat(document.getElementById('exitThreshold').value)
        };

        const resultContainer = document.getElementById('backtestResult');
        resultContainer.innerHTML = '<div class="alert alert-info">Running backtest...</div>';

        fetch('/api/backtest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    resultContainer.innerHTML = `<div class="alert alert-danger">${data.error || 'Backtest failed'}</div>`;
                    document.getElementById('equityChart').innerHTML = '';
                    return;
                }
                renderBacktestResult(data.result);
            })
            .catch(error => {
                resultContainer.innerHTML = `<div class="alert alert-danger">${error}</div>`;
                document.getElementById('equityChart').innerHTML = '';
            });
    }

    function renderBacktestResult(result) {
        const container = document.getElementById('backtestResult');
        const trades = result.trades || [];
        container.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">${result.symbol} (${result.timeframe})</h5>
                    <p class="card-text">Period: ${result.start_date} -> ${result.end_date}</p>
                    <div class="row">
                        <div class="col-md-3"><strong>Total return:</strong> ${result.total_return_pct}%</div>
                        <div class="col-md-3"><strong>Max drawdown:</strong> ${result.max_drawdown_pct}%</div>
                        <div class="col-md-3"><strong>Trades:</strong> ${result.trades_count}</div>
                        <div class="col-md-3"><strong>Win rate:</strong> ${result.win_rate_pct}%</div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-3"><strong>Final capital:</strong> $${result.final_capital}</div>
                        <div class="col-md-3"><strong>Average trade:</strong> ${result.average_trade_return_pct}%</div>
                        <div class="col-md-3"><strong>Entry >=</strong> ${result.entry_threshold}</div>
                        <div class="col-md-3"><strong>Exit >=</strong> ${result.exit_threshold}</div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                ${trades.length ? `<h5>Trades</h5>` : '<div class="alert alert-warning">No trades generated</div>'}
                ${trades.length ? `
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Entry</th>
                                    <th>Exit</th>
                                    <th>Entry >=rice</th>
                                    <th>Exit >=rice</th>
                                    <th>Return %</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${trades.map((trade, idx) => `
                                    <tr>
                                        <td>${idx + 1}</td>
                                        <td>${trade.entry_time}</td>
                                        <td>${trade.exit_time}</td>
                                        <td>${trade.entry_price}</td>
                                        <td>${trade.exit_price}</td>
                                        <td class="${trade.return_pct >= 0 ? 'text-success' : 'text-danger'}">${trade.return_pct.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}
            </div>
        `;

        if (result.equity_curve && result.equity_curve.length > 1) {
            const timestamps = result.equity_curve.map(point => point.timestamp);
            const equity = result.equity_curve.map(point => point.equity);
            Plotly.newPlot('equityChart', [
                {
                    x: timestamps,
                    y: equity,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Equity'
                }
            ], {
                title: 'Equity Curve',
                xaxis: { title: 'Timestamp' },
                yaxis: { title: 'Equity (USD)' },
                height: 350
            });
        } else {
            document.getElementById('equityChart').innerHTML = '';
        }
    }

    function refreshStatistics() {
        fetch('/api/statistics')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    return;
                }
                const stats = data.statistics;
                document.getElementById('statisticsContent').innerHTML = `
                    <div class="col-md-3">
                        <div class="card text-bg-primary mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Trades</h5>
                                <p class="card-text h3">${stats.total_trades}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-bg-success mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Win Rate</h5>
                                <p class="card-text h3">${stats.win_rate}%</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-bg-info mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Profit</h5>
                                <p class="card-text h3">${stats.total_profit}%</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-bg-warning mb-3">
                            <div class="card-body">
                                <h5 class="card-title">Positions</h5>
                                <p class="card-text h3">${stats.current_positions}</p>
                            </div>
                        </div>
                    </div>`;
            });
    }

    function refreshSignals() {
        fetch('/api/signals/current')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    return;
                }
                const list = document.getElementById('signalsList');
                list.innerHTML = '';
                Object.entries(data.signals).forEach(([symbol, payload]) => {
                    const alertClass = payload.signal === 'BUY' ? 'success' : (payload.signal === 'SELL' ? 'danger' : 'secondary');
                    list.innerHTML += `
                        <div class="alert alert-${alertClass}">
                            <strong>${symbol}</strong>: ${payload.signal}<br />
                            Probability: ${(payload.probability * 100).toFixed(1)}%<br />
                            Price: $${payload.price.toFixed(2)}
                        </div>`;
                });
            });
    }

    function refreshChart() {
        fetch('/api/market/data?symbol=BTC/USDT&timeframe=1h&limit=200')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    return;
                }
                const timestamps = data.data.map(row => row.timestamp);
                const prices = data.data.map(row => row.close);
                const ema20 = data.data.map(row => row.ema20);

                const layout = {
                    title: `${data.symbol} price and EMA20`,
                    xaxis: { title: 'Timestamp' },
                    yaxis: { title: 'Price (USDT)' },
                    height: 400
                };

                Plotly.newPlot('priceChart', [
                    { x: timestamps, y: prices, type: 'scatter', mode: 'lines', name: 'Close' },
                    { x: timestamps, y: ema20, type: 'scatter', mode: 'lines', name: 'EMA20' }
                ], layout);
            });
    }

    refreshStatistics();
    refreshSignals();
    refreshChart();
    setInterval(refreshStatistics, 15000);
    setInterval(refreshSignals, 15000);
    setInterval(refreshChart, 60000);
});
</script>
</body>
</html>
